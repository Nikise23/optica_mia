{% extends 'base.html' %}

{% block title %}Nuevo Pago · ÓpticaApp{% endblock %}

{% block content %}
<h2 class="mb-3">Nuevo Pago</h2>
<form method="post" class="row g-3" action="{{ url_for('caja_pago_create') }}">
  <div class="col-12">
    <label class="form-label">Receta</label>
    <select name="receta_id" class="form-select" required>
      <option value="">Seleccionar receta</option>
      {% for item in recetas_con_saldo %}
      <option value="{{ item.receta.id }}">
        {{ item.receta.paciente.apellido }}, {{ item.receta.paciente.nombre }} - {% if item.receta.medico %}{{ item.receta.medico.apellido }}, {{ item.receta.medico.nombre }}{% else %}Sin médico{% endif %} - Restante ${{ item.restante | round(2) }}
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-sm-6 col-lg-4">
    <label class="form-label">Método de pago</label>
    <select name="metodo_pago" class="form-select" required>
      <option value="">Seleccionar método</option>
      <option value="Efectivo">Efectivo</option>
      <option value="Tarjeta">Tarjeta</option>
      <option value="Transferencia">Transferencia</option>
    </select>
  </div>
  <div class="col-sm-6 col-lg-4">
    <label class="form-label">Monto (se autocompleta con total tras descuento)</label>
    <input id="monto" name="monto" type="number" step="0.01" min="0" class="form-control" required />
  </div>
  <div class="col-sm-6 col-lg-4">
    <label class="form-label">Descuento (%)</label>
    <input id="descuento" name="descuento" type="number" step="0.01" min="0" max="100" class="form-control" value="0" />
  </div>
  <div class="col-12">
    <div class="alert alert-info" id="resumenPago">
      Seleccione una receta para ver totales.
      <div class="d-flex gap-3 mt-2 align-items-center">
        <div class="form-check">
          <input class="form-check-input" type="radio" name="tipoPago" id="pagoParcial" value="parcial" checked>
          <label class="form-check-label" for="pagoParcial">Pago parcial</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="tipoPago" id="pagoTotal" value="total">
          <label class="form-check-label" for="pagoTotal">Pagar total restante</label>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('caja_dashboard') }}">Cancelar</a>
    <button class="btn btn-primary" type="submit">Registrar Pago</button>
  </div>
</form>
<script>
  const recetas = {
    {% for item in recetas_con_saldo %}
    {{ item.receta.id }}: { total: {{ item.receta.total or 0 }}, pagos: [
      {% for pg in item.receta.pagos %}{ monto: {{ pg.monto or 0 }}, d: {{ pg.descuento or 0 }} },{% endfor %}
    ] },
    {% endfor %}
  };
  const selectReceta = document.querySelector('select[name="receta_id"]');
  const monto = document.getElementById('monto');
  const descuento = document.getElementById('descuento');
  const radioParcial = document.getElementById('pagoParcial');
  const radioTotal = document.getElementById('pagoTotal');
  const resumen = document.getElementById('resumenPago');
  function actualizarResumen() {
    const rid = selectReceta.value;
    if (!rid || !recetas[rid]) { resumen.textContent = 'Seleccione una receta para ver totales.'; return; }
    let total = Number(recetas[rid].total) || 0;
    const pagos = recetas[rid].pagos || [];
    const pagado_neto = pagos.reduce((acc, p) => acc + Number(p.monto||0) * (1 - Number(p.d||0)/100), 0);
    const restante = Math.max(0, total - pagado_neto);
    const m = Number(monto.value) || 0;
    const d = Math.min(100, Math.max(0, Number(descuento.value) || 0));
    // Auto-completar monto con total tras descuento si pagoParcial no está marcado, o si monto vacío
    const totalConDesc = total * (1 - d/100);
    if (radioTotal.checked) {
      // Modo total: bloquear edición y sugerir total restante con descuento aplicado
      const sugerido = Math.max(0, totalConDesc - pagado_neto);
      monto.value = sugerido.toFixed(2);
      monto.readOnly = true;
    } else {
      // Modo parcial: permitir edición, no auto-sobrescribir lo que escribe el usuario
      if (!m) {
        // Si aún no escribió nada, sugerir algo amistoso (por ej. 0 o una seña típica)
        monto.value = '';
      }
      monto.readOnly = false;
    }
    // Si hay descuento y es el primer pago, actualizar el total mostrado
    if (d > 0 && pagos.length === 0) {
      total = totalConDesc;
    }
    const m2 = Number(monto.value) || 0;
    const neto = m2 * (1 - d / 100);
    resumen.innerHTML = `Total: $${total.toFixed(2)} · Descuento: ${d.toFixed(2)}% · Pagado neto: $${pagado_neto.toFixed(2)} · Restante: $${restante.toFixed(2)} · Pago neto actual: $${neto.toFixed(2)}`;
  }
  ['change','input'].forEach(evt => {
    selectReceta.addEventListener(evt, actualizarResumen);
    monto.addEventListener(evt, actualizarResumen);
    descuento.addEventListener(evt, actualizarResumen);
    radioParcial.addEventListener(evt, actualizarResumen);
    radioTotal.addEventListener(evt, actualizarResumen);
  });
  actualizarResumen();
</script>
{% endblock %}


