{% extends 'base.html' %}

{% block title %}Dashboard · ÓpticaApp{% endblock %}

{% block content %}
<div class="row g-3 mb-4">
  <div class="col-sm-6 col-lg-3">
    <div class="card text-bg-primary h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-title mb-1">Productos bajo stock</h6>
            <div class="display-6">{{ productos_bajo_stock | length }}</div>
          </div>
          <span class="bi bi-box-seam fs-1"></span>
        </div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card text-bg-success h-100">
      <div class="card-body">
        <h6 class="card-title mb-1">Recetas este mes</h6>
        <div class="display-6">{{ recetas_mes }}</div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card text-bg-warning h-100">
      <div class="card-body">
        <h6 class="card-title mb-1">Cierre de caja hoy</h6>
        <div class="display-6">{{ (cierre_hoy.total_general if cierre_hoy else 0) | round(2) }}</div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card text-bg-dark h-100">
      <div class="card-body">
        <h6 class="card-title mb-1">Saldo del mes</h6>
        <div class="display-6 {% if saldo_mes >= 0 %}text-success{% else %}text-danger{% endif %}">${{ saldo_mes | round(2) }}</div>
        <small class="text-muted">Recaudado: ${{ pagos_mes_neto | round(2) }} · Gastos: ${{ gastos_mes | round(2) }}</small>
      </div>
    </div>
  </div>
  </div>

<div class="card">
  <div class="card-header">Top 10 productos con bajo stock</div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped mb-0 align-middle">
        <thead>
          <tr>
            <th>Código</th>
            <th>Nombre</th>
            <th>Cantidad</th>
            <th>Stock mínimo</th>
          </tr>
        </thead>
        <tbody>
        {% if productos_bajo_stock %}
          {% for p in productos_bajo_stock %}
          <tr class="{% if p.cantidad <= p.stock_minimo %}table-danger{% endif %}">
            <td>{{ p.codigo }}</td>
            <td>{{ p.nombre }}</td>
            <td>{{ p.cantidad }}</td>
            <td>{{ p.stock_minimo }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="4" class="text-center text-muted">No hay productos con bajo stock.</td>
          </tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-header">Comisiones por médico (estimado)</div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead>
          <tr>
            <th>Médico</th>
            <th>% Comisión</th>
            <th>Total Comisión</th>
          </tr>
        </thead>
        <tbody>
          {% for item in comisiones_detalle %}
          <tr>
            <td>{{ item.medico.apellido }}, {{ item.medico.nombre }}</td>
            <td>{{ item.porcentaje | round(2) }}%</td>
            <td>{{ item.monto | round(2) }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="3" class="text-center text-muted">Sin datos de comisiones.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Gráfico de evolución diaria -->
<div class="card mt-4">
  <div class="card-header">Evolución diaria (últimos 30 días)</div>
  <div class="card-body">
    <canvas id="graficoEvolucion" width="400" height="200"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('graficoEvolucion').getContext('2d');
const datos = {{ datos_grafico | tojson }};

new Chart(ctx, {
  type: 'line',
  data: {
    labels: datos.map(d => d.fecha),
    datasets: [{
      label: 'Ingresos',
      data: datos.map(d => d.ingresos),
      borderColor: 'rgb(40, 167, 69)',
      backgroundColor: 'rgba(40, 167, 69, 0.1)',
      tension: 0.1
    }, {
      label: 'Gastos',
      data: datos.map(d => d.gastos),
      borderColor: 'rgb(220, 53, 69)',
      backgroundColor: 'rgba(220, 53, 69, 0.1)',
      tension: 0.1
    }, {
      label: 'Saldo',
      data: datos.map(d => d.saldo),
      borderColor: 'rgb(13, 110, 253)',
      backgroundColor: 'rgba(13, 110, 253, 0.1)',
      tension: 0.1
    }]
  },
  options: {
    responsive: true,
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          callback: function(value) {
            return '$' + value.toLocaleString();
          }
        }
      }
    },
    plugins: {
      tooltip: {
        callbacks: {
          label: function(context) {
            return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
          }
        }
      }
    }
  }
});
</script>
{% endblock %}